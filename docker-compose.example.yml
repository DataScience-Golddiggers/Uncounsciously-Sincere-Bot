version: '3.8'

services:
  # IL TUO BOT RASA
  rasa:
    container_name: rasa_server
    build: .
    ports:
      - "5005:5005"
    volumes:
      # Mappa la cartella corrente del Mac dentro al container.
      # Se modifichi i file yml sul Mac, Rasa li vede subito.
      - ./:/app
    environment:
      - RASA_TELEMETRY_ENABLED=false
    # Comando di avvio
    command: rasa run --enable-api --cors "*" --debug
    depends_on:
      - action_server # Rasa aspetta che l'action server sia pronto


  action_server:
    container_name: rasa_actions
    build: ./actions
    ports:
      - "5055:5055"
    volumes:
      - ./actions:/app/actions # Per modificare il codice python senza rebuildare
    environment:
      # CONFIGURA QUI LA TUA MAIL (Se usi Gmail, devi generare una "App Password")
      - SMTP_SERVER=${SMTP_SERVER}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_EMAIL=${SMTP_EMAIL}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
       # DB Connection
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
    depends_on:
      - db

  # OLLAMA (Local LLM Server)
  ollama:
    image: ollama/ollama:latest
    container_name: rasa_ollama
    ports:
      - "11434:11434"
    volumes:
      - ./ollama_data:/root/.ollama # Salva i modelli scaricati (es. qwen, gemma)
      - ./entrypoint.sh:/usr/bin/entrypoint.sh # Mount custom entrypoint script
    entrypoint: ["/usr/bin/entrypoint.sh"] # Use the custom entrypoint
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      default:

  # NGROK (Tunnel HTTPS per Telegram)
  ngrok:
    image: ngrok/ngrok:latest
    container_name: rasa_ngrok
    # Dice a ngrok di puntare alla porta 5005 del servizio 'rasa'
    command: "http rasa:5005"
    ports:
      - "4040:4040"
    environment:
      # INSERISCI QUI IL TUO TOKEN DI NGROK (OBBLIGATORIO)
      # Prendilo da: https://dashboard.ngrok.com/get-started/your-authtoken
      NGROK_AUTHTOKEN: "here the authtoken"
    depends_on:
      - rasa

  # DATABASE POSTGRES
  db:
    image: postgres:13
    container_name: rasa_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - ./database:/docker-entrypoint-initdb.d